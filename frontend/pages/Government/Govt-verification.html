<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Official Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #eaf4fc;
        }
        header {
            background-color: #0078D7;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .container {
            max-width: 1100px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2rem;
        }
        .tab {
            padding: 0.8rem 1.5rem;
            border: 1px solid #0078D7;
            border-radius: 4px;
            background-color: white;
            color: #0078D7;
            cursor: pointer;
            font-weight: bold;
        }
        .tab.active {
            background-color: #0078D7;
            color: white;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .card h2 {
            margin: 0;
            color: #333;
        }
        .card p {
            margin: 0.5rem 0;
            color: #555;
        }
        .status {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .status.pending { background-color: #ffeb3b; color: #333; }
        .status.approved { background-color: #4caf50; color: white; }
        .status.rejected { background-color: #f44336; color: white; }
        .status.completed { background-color: #3f51b5; color: white; }
        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            color: white;
            text-align: center;
            border-radius: 4px;
            text-decoration: none;
            font-size: 1rem;
            font-weight: bold;
            margin: 0.5rem;
        }
        .btn.approve { background-color: #4caf50; }
        .btn.reject { background-color: #f44336; }
        .btn.view { background-color: #0078D7; }
        .btn.transfer { background-color: #3f51b5; }
        .btn:hover { opacity: 0.9; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-content button {
            padding: 0.8rem;
            margin: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Government Official Verification</h1>
        <p>Manage property transactions and registrations</p>
    </header>
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="pending">Pending Requests <span id="pending-count">(0)</span></div>
            <div class="tab" data-tab="approved">Approved Requests</div>
            <div class="tab" data-tab="rejected">Rejected Requests</div>
            <div class="tab" data-tab="registered">Registered Lands</div>
            <div class="tab" data-tab="transfers">Transfer Ownership</div>
        </div>
        <div id="requests-container"></div>
    </div>
    <div id="meeting-modal" class="modal">
        <div class="modal-content">
            <h2>Schedule Meeting</h2>
            <form id="meeting-form">
                <label>Meeting Date</label>
                <input type="date" name="meetingDate" required>
                <label>Meeting Time</label>
                <input type="time" name="meetingTime" required>
                <label>Location</label>
                <input type="text" name="location" placeholder="Registrar Office Address" required>
                <button type="submit" class="btn approve">Schedule</button>
                <button type="button" class="btn reject" onclick="closeModal('meeting-modal')">Cancel</button>
            </form>
        </div>
    </div>
    <div id="transfer-modal" class="modal">
        <div class="modal-content">
            <h2>Transfer Ownership</h2>
            <form id="transfer-form">
                <label>Current Owner</label>
                <input type="text" name="currentOwner" readonly>
                <label>New Owner</label>
                <input type="text" name="newOwner" required>
                <label>New Owner ID</label>
                <input type="text" name="newOwnerId" placeholder="National ID / Passport Number" required>
                <label>Transfer Date</label>
                <input type="date" name="transferDate" required>
                <label>Transfer Fee Paid</label>
                <select name="feePaid" required>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
                <label>Verification Method</label>
                <select name="verificationMethod" required>
                    <option value="biometric">Biometric</option>
                    <option value="document">Document Verification</option>
                    <option value="both">Both</option>
                </select>
                <label>Notes</label>
                <input type="text" name="notes" placeholder="Optional notes about the transfer">
                <button type="submit" class="btn transfer">Complete Transfer</button>
                <button type="button" class="btn reject" onclick="closeModal('transfer-modal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        const tabs = document.querySelectorAll('.tab');
        const requestsContainer = document.getElementById('requests-container');
        let currentRequestId = null;
        let allRequests = [];

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (tab.dataset.tab === 'transfers') {
                    loadTransferableProperties();
                } else {
                    loadRequests(tab.dataset.tab);
                }
            });
        });

        async function loadRequests(status) {
            try {
                const response = await fetch(`/api/requests?status=${status}`, {
                    headers: { 'Authorization': document.cookie.split('auth=')[1] }
                });
                allRequests = await response.json();
                document.getElementById('pending-count').textContent = `(${allRequests.filter(r => r.status === 'pending').length})`;
                renderRequests(allRequests.filter(r => r.status === status));
            } catch (error) {
                console.error('Error loading requests:', error);
                requestsContainer.innerHTML = '<p>Failed to load requests.</p>';
            }
        }

        function renderRequests(requests) {
            requestsContainer.innerHTML = '';
            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h2>${req.property.address}</h2>
                    <p>${req.property.size} sq ft • $${req.property.price}</p>
                    <p>${req.property.description}</p>
                    <p>Type: ${req.type}</p>
                    <p>Documents: ${req.documents.length}</p>
                    <span class="status ${req.status}">${req.status.charAt(0).toUpperCase() + req.status.slice(1)}</span>
                    ${req.status === 'pending' ? `
                        <a href="#" class="btn view" onclick="viewDetails('${req._id}')">View Details</a>
                        <a href="#" class="btn approve" onclick="approveRequest('${req._id}', '${req.type}')">Approve</a>
                        <a href="#" class="btn reject" onclick="rejectRequest('${req._id}')">Reject</a>
                    ` : req.status === 'approved' && req.meeting ? `
                        <p>Meeting: ${new Date(req.meeting.date).toLocaleString()} at ${req.meeting.location}</p>
                        ${!req.transferCompleted ? `<a href="#" class="btn transfer" onclick="showTransferModal('${req._id}')">Process Transfer</a>` : ''}
                    ` : ''}
                    ${req.transferCompleted ? `<p><strong>Transfer completed on ${new Date(req.transferDate).toLocaleDateString()}</strong></p>` : ''}
                `;
                requestsContainer.appendChild(card);
            });
        }

        function loadTransferableProperties() {
            // Filter properties that are approved but not yet transferred
            const transferableProperties = allRequests.filter(req => 
                req.status === 'approved' && 
                (req.type === 'sell' || req.type === 'buy') && 
                req.meeting && 
                !req.transferCompleted
            );
            
            requestsContainer.innerHTML = '<h2>Properties Ready for Ownership Transfer</h2>';
            
            if (transferableProperties.length === 0) {
                requestsContainer.innerHTML += '<p>No properties ready for transfer.</p>';
                return;
            }
            
            transferableProperties.forEach(req => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h2>${req.property.address}</h2>
                    <p>${req.property.size} sq ft • $${req.property.price}</p>
                    <p>Current Owner: ${req.property.owner || 'Unknown'}</p>
                    <p>Type: ${req.type}</p>
                    <p>Meeting Date: ${new Date(req.meeting.date).toLocaleString()}</p>
                    <p>Meeting Location: ${req.meeting.location}</p>
                    <a href="#" class="btn transfer" onclick="showTransferModal('${req._id}')">Process Transfer</a>
                `;
                requestsContainer.appendChild(card);
            });
        }

        async function viewDetails(requestId) {
            try {
                const response = await fetch(`/api/requests/${requestId}`, {
                    headers: { 'Authorization': document.cookie.split('auth=')[1] }
                });
                const req = await response.json();
                alert(`Details:\nAddress: ${req.property.address}\nSize: ${req.property.size} sq ft\nPrice: $${req.property.price}\nDescription: ${req.property.description}\nDocuments: ${req.documents.join(', ')}`);
            } catch (error) {
                console.error('Error fetching details:', error);
                alert('Failed to load details.');
            }
        }

        async function approveRequest(requestId, type) {
            currentRequestId = requestId;
            if (type === 'sell' || type === 'buy') {
                document.getElementById('meeting-modal').style.display = 'flex';
            } else if (type === 'registration') {
                try {
                    const response = await fetch(`/api/requests/${requestId}/approve`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': document.cookie.split('auth=')[1]
                        },
                        body: JSON.stringify({ status: 'approved' })
                    });
                    if (response.ok) {
                        alert('Registration approved.');
                        loadRequests('pending');
                    } else {
                        alert('Failed to approve registration.');
                    }
                } catch (error) {
                    console.error('Error approving registration:', error);
                    alert('Server error.');
                }
            }
        }

        async function rejectRequest(requestId) {
            try {
                const response = await fetch(`/api/requests/${requestId}/reject`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': document.cookie.split('auth=')[1]
                    },
                    body: JSON.stringify({ status: 'rejected' })
                });
                if (response.ok) {
                    alert('Request rejected.');
                    loadRequests('pending');
                } else {
                    alert('Failed to reject request.');
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Server error.');
            }
        }

        document.getElementById('meeting-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const meetingData = {
                date: `${formData.get('meetingDate')}T${formData.get('meetingTime')}:00Z`,
                location: formData.get('location')
            };
            try {
                const response = await fetch(`/api/requests/${currentRequestId}/schedule`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': document.cookie.split('auth=')[1]
                    },
                    body: JSON.stringify({ status: 'approved', meeting: meetingData })
                });
                if (response.ok) {
                    alert('Meeting scheduled.');
                    closeModal('meeting-modal');
                    loadRequests('pending');
                } else {
                    alert('Failed to schedule meeting.');
                }
            } catch (error) {
                console.error('Error scheduling meeting:', error);
                alert('Server error.');
            }
        });

        function showTransferModal(requestId) {
            const request = allRequests.find(req => req._id === requestId);
            if (request) {
                currentRequestId = requestId;
                const transferForm = document.getElementById('transfer-form');
                transferForm.querySelector('[name="currentOwner"]').value = request.property.owner || 'Unknown';
                document.getElementById('transfer-modal').style.display = 'flex';
            }
        }

        document.getElementById('transfer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const transferData = {
                newOwner: formData.get('newOwner'),
                newOwnerId: formData.get('newOwnerId'),
                transferDate: formData.get('transferDate'),
                feePaid: formData.get('feePaid') === 'yes',
                verificationMethod: formData.get('verificationMethod'),
                notes: formData.get('notes'),
                transferCompleted: true
            };
            
            try {
                const response = await fetch(`/api/requests/${currentRequestId}/transfer`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': document.cookie.split('auth=')[1]
                    },
                    body: JSON.stringify(transferData)
                });
                
                if (response.ok) {
                    alert('Ownership transfer completed successfully.');
                    closeModal('transfer-modal');
                    const activeTab = document.querySelector('.tab.active').dataset.tab;
                    if (activeTab === 'transfers') {
                        loadTransferableProperties();
                    } else {
                        loadRequests(activeTab);
                    }
                } else {
                    alert('Failed to process ownership transfer.');
                }
            } catch (error) {
                console.error('Error processing transfer:', error);
                alert('Server error.');
            }
        });

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'meeting-modal') {
                document.getElementById('meeting-form').reset();
            } else if (modalId === 'transfer-modal') {
                document.getElementById('transfer-form').reset();
            }
        }

        // Initial load
        loadRequests('pending');
    </script>
</body>
</html>